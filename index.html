<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>URA DMP2025 Fringe Events</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <img src="ura-logo.png" alt="URA Logo" />
    <div class="header-text">
      <div class="title-block">
        <strong>DMP2025 Fringe Events</strong>
        <span class="subtitle"><em>Join our activities! Discover upcoming fringe events where you can learn, experience, and contribute to the Draft Master Plan 2025.</em></span>
      </div>
    </div>
  </header>
  <section class="pinned-card">
      <div class="image-container-pinned">
            <img src="/event-pictures/event3.jpg" alt="Self-guided Toa Payoh Heritage Trail" class="event-image" />
          </div>
          <div class="event-details">
            <div class="event-top">
              <div class="event-tags">
                <span class="tag date" style="background-color: #fcfcfc; color: #070707">Featured</span>
                <span class="tag date">Aug 15 - Aug 29</span>
                <span class="tag type type-self-guided-tour">
                  Self Guided Tour
              </div>
            </div>
            <div class="event-middle">
              <h2 class="event-title" style="color: #fcfcfc">Self-guided Toa Payoh Heritage Trail</h2>
              <p class="event-description" style="color: #fcfcfc">Explore Toa Payoh's iconic landmarks through a heritage trail. Visit us to redeem exclusive prizes (while stocks last)!</p>
            </div>
          </div>
          <div class="qr-container-pinned" style="background-color: transparent">
            <span class="qr-label" style="background-color: #fcfcfc; color: #353200;">Information</span>
            <img src="/event-qr/qr3.png" class="qr-code" />
          </div>
    </section>

  <main class="event-list" id="eventList"></main>
  
  <script>
    // Live reload every 30 seconds
    const CHECK_INTERVAL = 30000; // 30 seconds
    let currentVersion = null;

    async function checkVersion() {
      try {
        const response = await fetch('version.json', { cache: 'no-store' });
        const latestVersion = await response.text();

        if (currentVersion === null) {
          currentVersion = latestVersion.trim();
        } else if (latestVersion.trim() !== currentVersion) {
          console.log('New version detected, reloading...');
          location.reload(true);
        }
      } catch (e) {
        console.error('Version check failed:', e);
      }
    }

    setInterval(checkVersion, CHECK_INTERVAL);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      loadEvents();
    });

    async function loadEvents() {
      const response = await fetch("events.json");
      const data = await response.json();
      const events = data.events;
      const cutoffDate = new Date(data.cutoffDate);

      const container = document.getElementById("eventList");
      const today = new Date();

      events.forEach(event => {
        const endDate = new Date(event.endDate + "T23:59:59");
        const startDate = new Date(event.date + "T00:00:00");

        if (today > endDate) return; // Skip past events

        if (startDate > cutoffDate) return;

        const card = document.createElement("div");
        card.className = "event-card";
        card.setAttribute("data-status", event.status);

        const status = event.status;
        if (["remove"].includes(status)) return;
        let bgColor = "#02a630"; // default (sign-ups open)
        let labelColor = "";
        let labelTextColor = "";
        let labelText = "Sign-Ups Open";
        let qrImage = event.qr;

        if (status === "sold-out") {
          bgColor = "#d72c11";
          labelColor = "#710000";
          labelTextColor = "#ffffff";
          labelText = "Sold Out";
          qrImage = event.soldOutQr;
        } else if (status === "waitlist") {
          bgColor = "#ff9500";
          labelColor = "#b25c00";
          labelTextColor = "#ffffff";
          labelText = "Join Waitlist";
          qrImage = event.qr; 
        } else if (status === "information") {
          bgColor = "#02a630";
          labelColor = "";
          labelTextColor = "";
          labelText = "Information";
          qrImage = event.qr; 
        }

        card.innerHTML = `
          <div class="image-container">
            <img src="${event.image}" alt="${event.title}" class="event-image" />
          </div>
          <div class="event-details">
            <div class="event-top">
              <div class="event-tags">
                <span class="tag date">${formatDateRange(event.date, event.endDate)}</span>
                <span class="tag type type-${event.type.toLowerCase().replace(/\s+/g, '-')}">
                  ${formatType(event.type)}
              </div>
            </div>
            <div class="event-middle">
              <h2 class="event-title">${event.title}</h2>
              <p class="event-description">${event.description}</p>
            </div>
          </div>
          <div class="qr-container" style="background-color: ${bgColor}">
            <span class="qr-label" style="background-color: ${labelColor}; color: ${labelTextColor};">${labelText}</span>
            <img src="${qrImage}" class="qr-code" />
          </div>
        `;

        container.appendChild(card);
      });
        const extraCard = document.createElement("div");
        extraCard.className = "event-card special-card";
        extraCard.innerHTML = `
          <div class="special-card-content">
            <div class="special-card-text">
              <h2>Still looking?</h2>
              <p>Scan the QR Code to view our full Fringe Events Calendar</p>
            </div>
            <div class="special-card-qr">
              <img src="event-qr/qr-full-calendar.png" alt="Full Calendar QR" />
            </div>
          </div>
        `;
        container.appendChild(extraCard);

        // Animate cards into view
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add("animate");
              entry.target.classList.remove("animate-out");
            } else {
              entry.target.classList.remove("animate");
              entry.target.classList.add("animate-out");
            }
          });
        }, {
          threshold: 0.1
        });

        // Observe each card
        document.querySelectorAll('.event-card').forEach(card => {
          observer.observe(card);
        });

    }
    function formatDateRange(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);

      const startStr = formatDate(start);
      const endStr = formatDate(end);

      return startStr === endStr ? startStr : `${startStr} â€“ ${endStr}`;
    }
    function formatDate(dateStr) {
      const options = { day: '2-digit', month: 'short' };
      return new Date(dateStr).toLocaleDateString('en-GB', options);
    }
    function formatType(type) {
      return type
        .split(/(?=[A-Z])|[\s_-]/) // split camelCase or snake_case or kebab-case
        .filter(Boolean)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
  </script>
</body>
</html>
