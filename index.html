<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>URA DMP2025 Fringe Events</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <img src="ura-logo.png" alt="URA Logo" />
    <div class="header-text">
      <div class="title-block">
        <strong>DMP2025 Fringe Events</strong>
        <span class="subtitle"><em>Join our activities! Discover upcoming fringe events where you can learn, experience, and contribute to the Draft Master Plan 2025.</em></span>
      </div>
    </div>
  </header>
  <!-- Was: <section class="pinned-card">...</section> -->
  <section id="featured" class="pinned-card carousel"></section>
  <main class="event-list" id="eventList"></main>
  
  <script>
    // Live reload every 30 seconds
    const CHECK_INTERVAL = 30000; // 30 seconds
    let currentVersion = null;

    async function checkVersion() {
      try {
        const response = await fetch('version.json', { cache: 'no-store' });
        const latestVersion = await response.text();

        if (currentVersion === null) {
          currentVersion = latestVersion.trim();
        } else if (latestVersion.trim() !== currentVersion) {
          console.log('New version detected, reloading...');
          location.reload(true);
        }
      } catch (e) {
        console.error('Version check failed:', e);
      }
    }

    setInterval(checkVersion, CHECK_INTERVAL);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      loadEvents();
    });

    async function loadEvents() {
      const response = await fetch("events.json");
      const data = await response.json();
      const events = data.events;
      const cutoffDate = new Date(data.cutoffDate);

      // 1) Build the featured carousel at the top
      buildFeaturedCarousel({
        events,
        cutoffDate,
        mount: document.getElementById("featured"),
        maxSlides: 3,
        intervalMs: 15000
      });

      // 2) Render the normal list cards
      const container = document.getElementById("eventList");
      const today = new Date();

      events.forEach(event => {
        const endDate = new Date(event.endDate + "T23:59:59");
        const startDate = new Date(event.date + "T00:00:00");

        if (today > endDate) return;           // past
        if (startDate > cutoffDate) return;    // after cutoff
        if ((event.status || "").toLowerCase() === "remove") return;

        // label colors
        let bgColor = "#02a630", labelColor = "", labelTextColor = "", labelText = "Sign-Ups Open", qrImage = event.qr;
        const status = (event.status || "").toLowerCase();
        if (status === "sold-out") {
          bgColor = "#d72c11"; labelColor = "#710000"; labelTextColor = "#ffffff"; labelText = "Sold Out"; qrImage = event.soldOutQr || event.qr;
        } else if (status === "waitlist") {
          bgColor = "#ff9500"; labelColor = "#b25c00"; labelTextColor = "#ffffff"; labelText = "Join Waitlist";
        } else if (status === "information") {
          bgColor = "#02a630"; labelColor = ""; labelTextColor = ""; labelText = "Information";
        }

        const card = document.createElement("div");
        card.className = "event-card";
        card.setAttribute("data-status", status);

        card.innerHTML = `
          <div class="image-container">
            <img src="${event.image}" alt="${event.title}" class="event-image" />
          </div>
          <div class="event-details">
            <div class="event-top">
              <div class="event-tags">
                <span class="tag date">${formatDateRange(event.date, event.endDate)}</span>
                <span class="tag type type-${event.type.toLowerCase().replace(/\s+/g, '-')}">${formatType(event.type)}</span>
              </div>
            </div>
            <div class="event-middle">
              <h2 class="event-title">${event.title}</h2>
              <p class="event-description">${event.description}</p>
            </div>
          </div>
          <div class="qr-container" style="background-color:${bgColor}">
            <span class="qr-label" style="background-color:${labelColor}; color:${labelTextColor};">${labelText}</span>
            <img src="${qrImage}" class="qr-code" />
          </div>
        `;
        container.appendChild(card);
      });

      // Optional: your “Still looking?” special card
      const extraCard = document.createElement("div");
      extraCard.className = "event-card special-card";
      extraCard.innerHTML = `
        <div class="special-card-content">
          <div class="special-card-text">
            <h2>Still looking?</h2>
            <p>Scan the QR Code to view our full Fringe Events Calendar</p>
          </div>
          <div class="special-card-qr">
            <img src="event-qr/qr-full-calendar.png" alt="Full Calendar QR" />
          </div>
        </div>
      `;
      container.appendChild(extraCard);

      // Animate cards into view (your existing observer)
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("animate");
            entry.target.classList.remove("animate-out");
          } else {
            entry.target.classList.remove("animate");
            entry.target.classList.add("animate-out");
          }
        });
      }, { threshold: 0.1 });

      document.querySelectorAll('.event-card').forEach(card => observer.observe(card));
    }

    /* === Featured carousel builder === */
    function buildFeaturedCarousel({ events, cutoffDate, mount, maxSlides = 3, intervalMs = 6000 }) {
      if (!mount) return;

      const today = new Date();
      const featured = events
        .filter(e => e.featured === true)
        .filter(e => {
          const start = new Date(e.date + "T00:00:00");
          const end   = new Date(e.endDate + "T23:59:59");
          const status = (e.status || "").toLowerCase();
          if (today > end) return false;
          if (start > cutoffDate) return false;
          if (status === "remove") return false;
          return true;
        })
        .slice(0, maxSlides);

      if (featured.length === 0) { mount.style.display = "none"; return; }

      mount.innerHTML = `
        <div class="featured-track">
          ${featured.map((ev,i) => featuredSlideHTML(ev, i===0)).join("")}
        </div>
        <div class="featured-dots">
          ${featured.map((_,i)=>`<button class="dot ${i===0?'is-active':''}" data-i="${i}" aria-label="Slide ${i+1}"></button>`).join("")}
        </div>
      `;

      const slides = [...mount.querySelectorAll('.featured-slide')];
      const dots   = [...mount.querySelectorAll('.featured-dots .dot')];
      let idx = 0, timer;

            // ...existing code...
      const goto = (n) => {
        // Remove is-active from current slide
        slides[idx].classList.remove('is-active');
        idx = n;
        // Add is-active to new slide
        slides[idx].classList.add('is-active');
        // Update dots
        dots.forEach((dot, i) => {
          dot.classList.toggle('is-complete', i < idx);
          dot.classList.toggle('is-active', i === idx);
          if (i > idx) {
            dot.classList.remove('is-complete', 'is-active');
          }
        });
      };
      // ...existing code...

      const start = () => { if (slides.length > 1) timer = setInterval(()=>goto((idx+1)%slides.length), intervalMs); };
      const stop  = () => clearInterval(timer);

      dots.forEach(d => d.addEventListener('click', () => { stop(); goto(+d.dataset.i); start(); }));
      document.addEventListener('visibilitychange', () => document.hidden ? stop() : start());
      

      start();
    }

    function featuredSlideHTML(ev, active) {
  // normalize status
  const status = (ev.status || "").toLowerCase();

  // pick QR like list cards
  let labelText = "Information";
  let labelBg = "#fcfcfc";
  let labelColor = "#353200";
  let qrImage = ev.qr;

  if (status === "sold-out") {
    labelText = "Sold Out";
    labelBg = "#710000";
    labelColor = "#ffffff";
    qrImage = ev.soldOutQr || ev.qr;
  } else if (status === "waitlist") {
    labelText = "Join Waitlist";
    labelBg = "#b25c00";
    labelColor = "#ffffff";
  }

        // ...existing code...
        return `
          <article class="featured-slide ${active ? 'is-active' : ''}">
            <div class="image-container-pinned">
              <img
                src="${ev.image}"
                alt="${ev.title}"
                class="event-image"
                ${active ? 'loading="eager"' : 'loading="lazy"'}
                onerror="console.warn('Featured image not found:', this.src)"
              />
            </div>
    
            <div class="featured-body">
              <div class="event-top">
                <div class="event-tags">
                  <span class="tag date" style="background:#fff;color:#111">Featured</span>
                  <span class="tag date">${formatDateRange(ev.date, ev.endDate)}</span>
                  <span class="tag type type-${ev.type.toLowerCase().replace(/\s+/g,'-')}">
                    ${formatType(ev.type)}
                  </span>
                </div>
              </div>
              <div class="event-middle">
                <h2 class="event-title" style="color:#fcfcfc">${ev.title}</h2>
                <p class="event-description" style="color:#fcfcfc">${ev.description}</p>
              </div>
            </div>
    
            <aside class="featured-qr">
              <span class="qr-label" style="background:${labelBg};color:${labelColor}">${labelText}</span>
              <img src="${qrImage}" class="qr-code" alt="QR code"
                  onerror="console.warn('Featured QR not found:', this.src)" />
            </aside>
          </article>
        `;
    // ...existing code...
  }


    /* === helpers === */
    function formatDateRange(start, end) {
      const s = formatDate(start), e = formatDate(end);
      return s === e ? s : `${s} – ${e}`;
    }
    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
    }
    function formatType(type) {
      return type.split(/(?=[A-Z])|[\s_-]/).filter(Boolean)
        .map(w => w[0].toUpperCase()+w.slice(1)).join(' ');
    }
  </script>

</body>
</html>
